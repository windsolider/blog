---
title: http协议之缓存
date: 2018-04-12 19:43:04
tags:
---

## http协议之缓存
---------------

## 定义
缓存是指代理服务器或者客户端保存的资源副本

## 优点
* 缓解了网络的瓶颈的问题
缓存被重复使用，大大降低了用户的带宽使用，减少了服务器的压力
* 降低了距离时延
缓存离客户端更近，因此，从缓存请求内容比从源服务器所用时间更少，呈现速度更快，网站就显得更灵敏

## 分类
* 私有缓存(浏览器缓存)
* 公有缓存
    * 代理服务器缓存
    * 网关缓存(反向代理服务器缓存)


## 缓存相关的http字段
* Expires：指示响应内容过期的时间，格林威治时间GMT
* Cache-Control：更细致的控制缓存的内容    
* Last-Modified：响应中资源最后一次修改的时间
* ETag：响应中资源的校验值，在服务器上某个时段是唯一标识的。 
* Date：服务器的时间 
* If-Modified-Since：客户端存取的该资源最后一次修改的时间，同Last-Modified。 
* If-None-Match：客户端存取的该资源的检验值，同ETag。

## 缓存策略

* 强缓存
    * Expries 指定一个绝对过期日期。如果过期日期已经过了，就说明文档不再新鲜了
    * cache-control max-age：max-age值定义了文档的最大使用期——从第一次生成文档到文档不再新鲜，无法使用为止，最大的合法生存时间（以秒为单位）
* 协商缓存
    * last-Modified
    * etag

## 总结
当浏览器第一次对于服务器上的资源请求时候，http请求的响应头中可以通过设置cache-control(1.1)或者Expires(1.0)字段强制要求浏览器对资源进行缓存。假定在首次获取资源120秒后，浏览器又对该资源发起请求。首先，浏览器会检查本地缓存并找到之前的响应，通过date字段与cache-control字段的时间进行比对，（date字段表示当前http报文生成日期），判断该缓存是否过期。如果未过期，则继续使用本地缓存内容。如果过期，浏览器直接发起新的请求并获取完新的完整响应。浏览器的请求头中将之前第一次接收到的etag内容通过if-none-match发送给服务器，如果服务器上的etag内容与客户端发送过来的if-none-match内容一致，则表示资源未发生变化，浏览器可以继续使用本地缓存。如果不一致，则服务器返回最新的资源给浏览器。

需要注意的是，响应报文中Expires所定义的缓存时间是相对服务器上的时间而言的，其定义的是资源“失效时刻”，如果客户端上的时间跟服务器上的时间不一致（特别是用户修改了自己电脑的系统时间），那缓存时间可能就没啥意义了。

ps: 如何查看chrome浏览器本地缓存
* 打开chrome浏览器
* 在chrome浏览器地址栏中输入chrome://chrome-urls/,打开所有chrome-URL相关的列表页面
* 在列表中选择chrome://cache，打开缓存页面看到缓存的资源列表
* 浏览器的缓存资源中date记录的是第一次http请求中的响应头报文创建时间
浏览器发出的所有http请求会首先路由到浏览器缓存，以确认是否缓存了可用于满足请求的有效响应

## 用户行为与缓存
浏览器缓存行为还有用户的行为有关，具体情况如下：

用户操作 | Expires/Cache-Control | Last-Modified/Etag 
- | :-: | -: 
地址栏回车 | 有效 | 有效 
页面链接跳转 | 有效 | 有效 
新开窗口 | 有效 | 有效
前进、后退 | 有效 | 有效
F5刷新 | 无效(浏览器重置Cache-Control: max-age=0) | 有效
Ctrl+F5刷新(command+shift+r) | 无效（浏览器重置Cache-Control: no-cache） | 无效（请求头丢弃该选项)
点击刷新 | 无效(浏览器重置Cache-Control: max-age=0) | 有效

当下大多数浏览器在点击刷新按钮或按F5时会自行加上“Cache-Control:max-age=0”请求字段，所以我们先约定成俗——后文提及的“刷新”多指的是选中url地址栏并按回车键（这样不会被强行加上Cache-Control）。


## reference
-------------------
* [浏览器中输入url后发生了什么](https://www.jianshu.com/p/c1dfc6caa520)
* [在浏览器中输入URL并回车后都发生了什么](https://www.cnblogs.com/tisikcci/p/5866753.html)




